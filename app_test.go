package main

import (
	"fmt"
	"io/ioutil"
	"net/http"
	"net/http/httptest"
	"net/url"
	"os"
	"strings"
	"testing"

	"cfv-api/config"

	"gorm.io/driver/postgres"
	"gorm.io/gorm"
)

func TestLoadDSN(t *testing.T) {

	if _, err := config.LoadDSN(); err != nil {
		t.Error(err)
	}

	envKeys := []string{"DB_HOST", "DB_USER", "DB_PASSWORD", "DB_DB", "DB_PORT"}

	for _, key := range envKeys {
		if _, exists := os.LookupEnv(key); exists == false {
			t.Errorf("Error looking up environment variable %s", key)
		}
	}
}

func TestConnection(t *testing.T) {

	dsn, err := config.LoadDSN()

	if err != nil {
		t.Error(err)
	}

	dialector := postgres.New(postgres.Config{DSN: dsn, PreferSimpleProtocol: true})

	if _, err := gorm.Open(dialector, &gorm.Config{}); err != nil {
		t.Error(err)
	}
}

func TestApp(t *testing.T) {
	// These test cases are nested since they have layered dependencies
	app, err := config.SetupApp()

	if err != nil {
		t.Error(err)
	}

	t.Run("api", func(t *testing.T) {
		ts := httptest.NewServer(app)
		defer ts.Close()

		// Have to set the port of the URL manually
		// TODO: Use regex to read and replace the default port
		baseURL := strings.Replace(ts.URL, "27751", "8080", 1)

		var apiPath string

		t.Run("v1", func(t *testing.T) {
			apiPath = "/api/v1"

			var endpointPath string

			t.Run("cards", func(t *testing.T) {
				endpointPath = "/cards"
				reqURL := fmt.Sprintf("%s%s%s", baseURL, apiPath, endpointPath)
				cardName := "Abyss Healer"

				t.Run(fmt.Sprintf("Get cards named %q", cardName),
					func(t *testing.T) {
						expected := `[{"CardType":"Trigger Unit","Clan":"Shadow Paladin","Critical":1,"DesignIllus":"","Effect":"(You may only have up to four cards with \"HEAL\" in a deck.)","Flavor":"Not yet! I will not let you fall before we demolish the enemy!","Format":"Premium Standard","Grade":"0","Illust":"Azusa","IllustColor":"","Illust2":"","Illust3":"","Illust4":"","Illust5":"","ImageUrlEn":"https://static.wikia.nocookie.net/cardfight/images/7/79/BT04-053EN-C.jpg/revision/latest/scale-to-width-down/274?cb=20121214165408","ImageUrlJp":"https://static.wikia.nocookie.net/cardfight/images/b/b6/Abyss_Healer.png/revision/latest/scale-to-width-down/274?cb=20111029172311","ImaginaryGift":"","Italian":"Guaritrice dell'Abisso","Kana":"アビス・ヒーラー","Kanji":"","Korean":"","LimitationText":"","MangaIllust":"","Name":"Abyss Healer","Nation":"United Sanctuary","Note":"","OtherNames":"","Phonetic":"Abisu Hīrā","Power":5000,"Race":"Angel","RideSkill":"","Sets":["Booster Set 4: Eclipse of Illusionary Shadows"],"TournamentStatuses":{"En":"Unrestricted","Jp":"Unrestricted","Kr":"Unrestricted","Th":"Unrestricted","It":"Unrestricted"},"Shield":10000,"Skill":"Boost","Thai":"","Translation":"","TriggerEffect":"Heal / +5000"},{"CardType":"Trigger Unit","Clan":"Shadow Paladin","Critical":1,"DesignIllus":"Azusa / 天城望","Effect":"(You may only have up to four cards with \"HEAL\" in a deck.)","Flavor":"(V-TD04): Those with the will to fight will never give up!(V-BT04): I don't believe you wish to die like this!(V-BT06): Change the pain of your wounds into anger. And stand up once more!","Format":"Standard / Premium Standard","Grade":"0","Illust":"","IllustColor":"","Illust2":"","Illust3":"","Illust4":"","Illust5":"","ImageUrlEn":"https://static.wikia.nocookie.net/cardfight/images/9/90/V-TD04-015EN.png/revision/latest/scale-to-width-down/274?cb=20180915162720","ImageUrlJp":"https://static.wikia.nocookie.net/cardfight/images/a/a9/V-TD04-015.png/revision/latest/scale-to-width-down/274?cb=20180809140951","ImaginaryGift":"","Italian":"Guaritrice dell'Abisso","Kana":"アビス・ヒーラー","Kanji":"","Korean":"","LimitationText":"","MangaIllust":"","Name":"Abyss Healer","Nation":"United Sanctuary","Note":"","OtherNames":"","Phonetic":"Abisu Hīrā","Power":5000,"Race":"Angel","RideSkill":"","Sets":["V Booster Set 04: Vilest! Deletor","V Booster Set 06: Phantasmal Steed Restoration","V Extra Booster 12: Team Dragon's Vanity!","V Special Series 03: Start Deck Blaster Dark","V Trial Deck 04: Ren Suzugamori"],"TournamentStatuses":{"En":"Unrestricted","Jp":"Unrestricted","Kr":"Unrestricted","Th":"Unrestricted","It":"Unrestricted"},"Shield":20000,"Skill":"Boost","Thai":"","Translation":"","TriggerEffect":"Heal / +10000"}]`
						res, err := getHttpResponseString(fmt.Sprintf("%s?name=%s", reqURL, url.PathEscape(cardName)))
						if err != nil {
							t.Error(err)
						}
						if res != expected {
							t.Errorf("URL:%q\nResponse: %q\nExpected:%q", reqURL, res, expected)
						}
					})

			})

			t.Run("sets", func(t *testing.T) {
				endpointPath = "/sets"
				reqURL := fmt.Sprintf("%s%s%s", baseURL, apiPath, endpointPath)

				t.Run("Get all sets",
					func(t *testing.T) {
						expected := `["Booster Set 10: Triumphant Return of the King of Knights","Booster Set 11: Seal Dragons Unleashed","Booster Set 12: Binding Force of the Black Rings","Booster Set 13: Catastrophic Outbreak","Booster Set 14: Brilliant Strike","Booster Set 15: Infinite Rebirth","Booster Set 16: Legion of Dragons \u0026 Blades","Booster Set 16: Legion of Dragons \u0026 Blades ver.E","Booster Set 17: Blazing Perdition","Booster Set 17: Blazing Perdition ver.E","Booster Set 1: Descent of the King of Knights","Booster Set 2: Onslaught of Dragon Souls","Booster Set 3: Demonic Lord Invasion","Booster Set 4: Eclipse of Illusionary Shadows","Booster Set 5: Awakening of Twin Blades","Booster Set 6: Breaker of Limits","Booster Set 7: Rampage of the Beast King","Booster Set 8: Blue Storm Armada","Booster Set 9: Clash of the Knights \u0026 Dragons","Burst Deck","Character Deck 4: Deck of Mysterious Fighter Masks","D Booster Set 01: Genesis of the Five Greats","D Start Deck 01: Yu-yu Kondo -Holy Dragon-","D Start Deck 02: Danji Momoyama -Tyrant Tiger-","D Start Deck 03: Tohya Ebata -Apex Ruler-","D Start Deck 04: Megumi Okura -Sylvan King-","D Start Deck 05: Tomari Seto -Aurora Valkyrie-","DAIGO Special Set","DAIGO Special Set G","Daikengo Deck","Deck Set: Touken Ranbu -Hanamaru-","Extra Booster: Banquet of Divas","Extra Booster: Cavalry of Black Steel","Extra Booster: Celestial Valkyries","Extra Booster: Champions of the Cosmos","Extra Booster: Comic Style Vol. 1","Extra Booster: Dazzling Divas","Extra Booster: Divas Duet","Extra Booster: Divine Dragon Progression","Extra Booster: Extra Collection vol.1","Extra Booster: Infinite Phantom Legion","Extra Booster: Mystical Magus","Extra Booster: Requiem at Dusk","Extra Booster: Waltz of the Goddess","Fighters Collection 2013","Fighters Collection 2014","Fighters Collection 2015","Fighters Collection 2015 Winter","Fighters Collection 2016","Fighters Collection 2017","Fighters Gacha Pickup: Awakening of Twin Blades","Fighters Gacha Pickup: Banquet of Divas","Fighters Gacha Pickup: Blue Storm Armada","Fighters Gacha Pickup: Cavalry of Black Steel","Fighters Gacha: Asia Circuit","Fighters Gacha: Rivals","Fighters Gacha: Team Q4","G Booster Set 10: Raging Clash of the Blade Fangs","G Booster Set 11: Demonic Advent","G Booster Set 12: Dragon King's Awakening","G Booster Set 13: Ultimate Stride","G Booster Set 14: Divine Dragon Apocrypha","G Booster Set 1: Generation Stride","G Booster Set 1: Trascendenza Interdimensionale","G Booster Set 2: Assalto Fulmineo delle Fiamme Roventi","G Booster Set 2: Soaring Ascent of Gale \u0026 Blossom","G Booster Set 3: Potere Supremo del Drago Stellare","G Booster Set 3: Sovereign Star Dragon","G Booster Set 4: Soul Strike Against The Supreme","G Booster Set 5: Moonlit Dragonfang","G Booster Set 6: Transcension of Blade and Blossom","G Booster Set 7: Glorious Bravery of Radiant Sword","G Booster Set 8: Absolute Judgment","G Booster Set 9: Divine Dragon Caper","G Character Booster 1: TRY3 NEXT","G Character Booster 2: WE ARE!!! TRINITY DRAGON","G Character Booster 3: Rummy Labyrinth Under the Moonlight","G Clan Booster 1: Academy of Divas","G Clan Booster 2: Commander of the Incessant Waves","G Clan Booster 3: Blessing of Divas","G Clan Booster 4: Gear of Fate","G Clan Booster 5: Prismatic Divas","G Clan Booster 6: Rondeau of Chaos \u0026 Salvation","G Clan Booster 7: Divas' Festa","G Comic Booster 1: Vanguard \u0026 Deletor","G Extra Booster 1: Cosmic Roar","G Extra Booster 2: The AWAKENING ZOO","G Extra Booster 3: The GALAXY STAR GATE","G Legend Deck 1: The Dark \"Ren Suzugamori\"","G Legend Deck 2: The Overlord blaze \"Toshiki Kai\"","G Legend Deck 3: The Blaster \"Aichi Sendou\"","G Start Deck 1: Odyssey of the Interspatial Dragon","G Start Deck 2: Knight of the Sun","G Technical Booster 1: The RECKLESS RAMPAGE","G Technical Booster 2: The GENIUS STRATEGY","G Title Booster 1: Touken Ranbu -ONLINE-","G Title Booster 2: Touken Ranbu -ONLINE-","G Title Trial Deck 1: Touken Ranbu -ONLINE-","G Trial Deck 10: Ritual of Dragon Sorcery","G Trial Deck 11: Divine Knight of Heavenly Decree","G Trial Deck 12: Flower Princess of Abundant Blooming","G Trial Deck 13: Evil Eye Sovereign","G Trial Deck 14: Debut of the Divas","G Trial Deck 15: Messiah Dragon of Rebirth","G Trial Deck 1: Awakening of the Interdimensional Dragon","G Trial Deck 2: Divine Swordsman of the Shiny Star","G Trial Deck 3: Flower Maiden of Purity","G Trial Deck 4: Blue Cavalry of the Divine Marine Spirits","G Trial Deck 5: Fateful Star Messiah","G Trial Deck 6: Rallying Call of the Interspectral Dragon","G Trial Deck 7: Illusionist of the Crescent Moon","G Trial Deck 8: Vampire Princess of the Nether Hour","G Trial Deck 9: True Zodiac Time Beasts","Gouki Daimonji's Challenge ~The Burning Heart of a Pirate~","Gouki Daimonji's Resolve ~A Man Must Prove Himself~","KAD1: Stardrive Deck","KAD2: Crested Deck","KAD3: Dinas Deck","KAD4: Joker Deck","KAD5: Lucan Deck","List of Promo Cards","List of V Promo Cards","Mega Trial Deck 1: Rise to Royalty","Monthly Bushiroad","Monthly Bushiroad Deck 1","Monthly Bushiroad Deck 2","Monthly Bushiroad Deck 3","Movie Booster 1: Neon Messiah","Movie Trial Deck 1: Malefic Deletor","Promo Cards","Rank Fight","Revival Collection Vol. 1","Revival Collection Vol. 2","SW Booster Set 1: SWEAT16! Iconic Collection","Starter Set: Dimensional Brave Kaiser","Starter Set: Liberator of the Sanctuary","Starter Set: Purgatory Revenger","Starter Set: Star-vader Invasion","Thailand Booster Set 1: The Mask Collection","Thailand Trial Deck 1: The Mask Collection","Thailand Trial Deck 2: The Mask Collection Neo Warriors Strengthen","Trial Deck 10: Purgatory Revenger","Trial Deck 11: Star-vader Invasion","Trial Deck 12: Dimensional Brave Kaiser","Trial Deck 13: Successor of the Sacred Regalia","Trial Deck 14: Seeker of Hope","Trial Deck 15: Brawler of Friendship","Trial Deck 16: Divine Judgment of the Bluish Flames","Trial Deck 17: Will of the Locked Dragon","Trial Deck 1: Blaster Blade","Trial Deck 2: Dragonic Overlord","Trial Deck 3: Golden Mechanical Soldier","Trial Deck 4: Maiden Princess of the Cherry Blossoms","Trial Deck 5: Slash of Silver Wolf","Trial Deck 6: Resonance of Thunder Dragon","Trial Deck 7: Descendants of the Marine Emperor","Trial Deck 8: Liberator of the Sanctuary","Trial Deck 9: Eradicator of the Empire","V Animation Trial Deck 01: Detective Conan","V Animation Trial Deck 02: Detective Conan","V Booster Set 01: Unite! Team Q4","V Booster Set 02: Strongest! Team AL4","V Booster Set 03: Miyaji Academy Cardfight Club","V Booster Set 04: Vilest! Deletor","V Booster Set 05: Aerial Steed Liberation","V Booster Set 06: Phantasmal Steed Restoration","V Booster Set 07: Infinideity Cradle","V Booster Set 08: Silverdust Blaze","V Booster Set 09: Butterfly d'Moonlight","V Booster Set 10: Phantom Dragon Aeon","V Booster Set 11: Storm of the Blue Cavalry","V Booster Set 12: Divine Lightning Radiance","V Collector's Set 01: Q4 vs. AL4","V Collector's Set 02: Memoir of Vanguard Koshien","V Extra Booster 01: The Destructive Roar","V Extra Booster 02: Champions of the Asia Circuit","V Extra Booster 03: ULTRARARE MIRACLE COLLECTION","V Extra Booster 04: The Answer of Truth","V Extra Booster 05: Primary Melody","V Extra Booster 06: Light of Salvation, Logic of Destruction","V Extra Booster 07: The Heroic Evolution","V Extra Booster 08: My Glorious Justice","V Extra Booster 09: The Raging Tactics","V Extra Booster 10: The Mysterious Fortune","V Extra Booster 11: Crystal Melody","V Extra Booster 12: Team Dragon's Vanity!","V Extra Booster 13: The Astral Force","V Extra Booster 14: The Next Stage","V Extra Booster 15: Twinkle Melody","V Mini Booster 01: PSYqualia Strife","V Promo Cards","V Special Series 01: PREMIUM COLLECTION 2019","V Special Series 02: Start Deck Blaster Blade","V Special Series 03: Start Deck Blaster Dark","V Special Series 05: Festival Collection","V Special Series 06: Special Deck Set Majesty Lord Blaster","V Special Series 07: PREMIUM COLLECTION 2020","V Special Series 08: DAIGO Special Expansion Set V","V Special Series 09: CLAN SELECTION PLUS Vol.1","V Special Series 10: CLAN SELECTION PLUS Vol.2","V Start Deck 01: 2018 Free Experience Deck \"Royal Paladin\"","V Start Deck 02: 2018 Free Experience Deck \"Kagero\"","V Title Booster 01: BanG Dream! FILM LIVE","V Trial Deck 01: Aichi Sendou","V Trial Deck 02: Toshiki Kai","V Trial Deck 03: Leon Soryu","V Trial Deck 04: Ren Suzugamori","V Trial Deck 05: Misaki Tokura","V Trial Deck 06: Naoki Ishida","V Trial Deck 07: Kouji Ibuki","V Trial Deck 08: Schokolade Melody","V Trial Deck 09: Shinemon Nitta","V Trial Deck 10: Chronojet","V Trial Deck 11: Altmile","V Trial Deck 12: Ahsha"]`
						res, err := getHttpResponseString(reqURL)
						if err != nil {
							t.Error(err)
						}
						if res != expected {
							t.Errorf("URL:%q\nResponse: %q\nExpected:%q", reqURL, res, expected)
						}
					})

			})

			t.Run("set", func(t *testing.T) {
				endpointPath = "/set"
				reqURL := fmt.Sprintf("%s%s%s", baseURL, apiPath, endpointPath)
				setName := "Burst Deck"

				t.Run("Get all cards in set",
					func(t *testing.T) {
						expected := `{"Name":"Burst Deck","Cards":[{"CardType":"","Clan":"Royal Paladin","Critical":1,"DesignIllus":"","Effect":"[AUTO]:[Counter Blast (2)] When this unit is placed on (VC), you may pay the cost. If you do, choose one of your opponent's rear-guards, and retire it.[AUTO]:[Counter Blast (2)] When this unit is placed on (RC), if you have a «Royal Paladin» vanguard, you may pay the cost. If you do, choose one of your opponent's grade 2 or greater rear-guards, and retire it.","Flavor":"(TD01/G-LD03 JP): Shine forth, brave sword and defender of the weak! Blaster Blade!(BT01): Courage is the sword of light. Shine forth, Blaster Blade!(FC01): Arise, my avatar!(PR/0267): Courage is the sword of light.(G-LD03 EN): Oh brave sword that defends the weak, shine, Blaster Blade!","Format":"Premium Standard","Grade":"2","Illust":"伊藤彰","IllustColor":"","Illust2":"","Illust3":"","Illust4":"","Illust5":"","ImageUrlEn":"https://static.wikia.nocookie.net/cardfight/images/c/cc/G-LD03-009EN.png/revision/latest/scale-to-width-down/274?cb=20170524002645","ImageUrlJp":"https://static.wikia.nocookie.net/cardfight/images/0/0f/MB-066.png/revision/latest/scale-to-width-down/274?cb=20170524033113","ImaginaryGift":"","Italian":"Distruttore delle Lame","Kana":"ブラスター・ブレード","Kanji":"","Korean":"블래스터 블레이드","LimitationText":"","MangaIllust":"","Name":"Blaster Blade","Nation":"United Sanctuary","Note":"","OtherNames":"","Phonetic":"Burasutā Burēdo","Power":9000,"Race":"Human","RideSkill":"","Sets":null,"TournamentStatuses":{"En":"","Jp":"","Kr":"","Th":"","It":""},"Shield":5000,"Skill":"Intercept","Thai":"บลาสเตอร์ เบลด","Translation":"","TriggerEffect":""},{"CardType":"","Clan":"Royal Paladin","Critical":1,"DesignIllus":"","Effect":"[CONT](VC):This unit cannot be boosted by your units.[AUTO](VC):[Counter Blast (2)-«Royal Paladin»] When this unit attacks a vanguard, you may pay the cost. If you do, increase this unit's [Power] by the total original [Power] of all of your «Royal Paladin» rear-guards in your front row until end of that battle.[AUTO](VC):When this unit attacks a vanguard, this unit gets [Power]+3000 until end of that battle.","Flavor":"There is a world that only those who grow will know of. Shine, Blaster Blade!","Format":"Premium Standard","Grade":"3","Illust":"伊藤彰","IllustColor":"","Illust2":"","Illust3":"","Illust4":"","Illust5":"","ImageUrlEn":"https://static.wikia.nocookie.net/cardfight/images/9/99/0412EN.jpg/revision/latest/scale-to-width-down/274?cb=20180322175107","ImageUrlJp":"https://static.wikia.nocookie.net/cardfight/images/9/9c/VZ-001.jpg/revision/latest/scale-to-width-down/274?cb=20130412143852","ImaginaryGift":"","Italian":"","Kana":"ブラスター・ブレード・バースト","Kanji":"","Korean":"","LimitationText":"","MangaIllust":"","Name":"Blaster Blade Burst","Nation":"United Sanctuary","Note":"","OtherNames":"","Phonetic":"Burasutā Burēdo Bāsuto","Power":10000,"Race":"Human","RideSkill":"","Sets":null,"TournamentStatuses":{"En":"","Jp":"","Kr":"","Th":"","It":""},"Shield":0,"Skill":"Twin Drive!!","Thai":"","Translation":"","TriggerEffect":""},{"CardType":"Trigger Unit","Clan":"Royal Paladin","Critical":1,"DesignIllus":"","Effect":"","Flavor":"(TD01/KAD1/VZ/DG01/MT01): Take that! Bull's eye!  (G-DG01): I did it! I hit the jackpot!","Format":"Premium Standard","Grade":"0","Illust":"安達洋介","IllustColor":"","Illust2":"","Illust3":"","Illust4":"","Illust5":"","ImageUrlEn":"https://static.wikia.nocookie.net/cardfight/images/c/c9/MT01-014EN.jpg/revision/latest/scale-to-width-down/274?cb=20131121182659","ImageUrlJp":"https://static.wikia.nocookie.net/cardfight/images/f/fb/G-DG01-016.png/revision/latest/scale-to-width-down/274?cb=20160529155501","ImaginaryGift":"","Italian":"Epona, Portatrice della Buona Sorte","Kana":"こううんのはこびて エポナ","Kanji":"幸運の運び手 エポナ","Korean":"","LimitationText":"","MangaIllust":"","Name":"Bringer of Good Luck, Epona","Nation":"United Sanctuary","Note":"","OtherNames":"","Phonetic":"Koūn no Hakobite Epona","Power":5000,"Race":"Sylph","RideSkill":"","Sets":null,"TournamentStatuses":{"En":"","Jp":"","Kr":"","Th":"","It":""},"Shield":10000,"Skill":"Boost","Thai":"","Translation":"","TriggerEffect":"Critical / +1, +5000"},{"CardType":"","Clan":"Royal Paladin","Critical":1,"DesignIllus":"","Effect":"[AUTO]:Forerunner (When a unit of the same clan rides this unit, you may call this unit to (RC))[ACT](RC):[Put this unit into your soul] Choose up to one of your «Royal Paladin», and that unit gets [Power]+3000 until end of turn.","Flavor":"(VZ): The future only falls on the hand of those who stand and believe the possibilities!(PR): The supports from our hearts, may reach to deep within their hearts.","Format":"Premium Standard","Grade":"0","Illust":"伊藤彰","IllustColor":"","Illust2":"","Illust3":"","Illust4":"","Illust5":"","ImageUrlEn":"","ImageUrlJp":"https://static.wikia.nocookie.net/cardfight/images/c/c8/PR-0197.png/revision/latest/scale-to-width-down/274?cb=20140417111316","ImaginaryGift":"","Italian":"","Kana":"くらうでぃあ","Kanji":"","Korean":"","LimitationText":"","MangaIllust":"","Name":"Claudia","Nation":"United Sanctuary","Note":"","OtherNames":"","Phonetic":"Kuraudia","Power":4000,"Race":"High Beast","RideSkill":"","Sets":null,"TournamentStatuses":{"En":"","Jp":"","Kr":"","Th":"","It":""},"Shield":10000,"Skill":"Boost","Thai":"","Translation":"","TriggerEffect":""},{"CardType":"","Clan":"Royal Paladin","Critical":1,"DesignIllus":"","Effect":"[AUTO](VC/RC):When this unit attacks, if the number of cards in your hand is greater than your opponent's, this unit gets [Power]+3000 until end of that battle.","Flavor":"(TD01): Hey hey hey! I'll blow you away!(BT01): Take that!","Format":"Premium Standard","Grade":"2","Illust":"米谷尚展","IllustColor":"","Illust2":"","Illust3":"","Illust4":"","Illust5":"","ImageUrlEn":"https://static.wikia.nocookie.net/cardfight/images/1/13/BT01-041EN_C.jpg/revision/latest/scale-to-width-down/274?cb=20120214195147","ImageUrlJp":"https://static.wikia.nocookie.net/cardfight/images/d/d4/VZ-008.jpg/revision/latest/scale-to-width-down/274?cb=20130412144306","ImaginaryGift":"","Italian":"Randolf, Cavaliere del Patto","Kana":"めいやくのきし ランドルフ","Kanji":"盟約の騎士 ランドルフ","Korean":"","LimitationText":"","MangaIllust":"","Name":"Covenant Knight, Randolf","Nation":"United Sanctuary","Note":"","OtherNames":"","Phonetic":"Meiyaku no Kishi Randorufu","Power":8000,"Race":"Human","RideSkill":"","Sets":null,"TournamentStatuses":{"En":"","Jp":"","Kr":"","Th":"","It":""},"Shield":5000,"Skill":"Intercept","Thai":"อัศวินแห่งสนธิสัญญา แรนดอล์ฟ","Translation":"","TriggerEffect":""},{"CardType":"Trigger Unit","Clan":"Royal Paladin","Critical":1,"DesignIllus":"","Effect":"","Flavor":"(TD01/MT01/KAD3/VZ/DG01): Wake up, sleepyhead!(BT01): How much longer are you sleeping? Wake up!","Format":"Premium Standard","Grade":"0","Illust":"松島一夫","IllustColor":"","Illust2":"","Illust3":"","Illust4":"","Illust5":"","ImageUrlEn":"https://static.wikia.nocookie.net/cardfight/images/d/df/MT01-016EN.jpg/revision/latest/scale-to-width-down/274?cb=20131121182958","ImageUrlJp":"https://static.wikia.nocookie.net/cardfight/images/1/1b/DG01-016.jpg/revision/latest/scale-to-width-down/274?cb=20130602230735","ImaginaryGift":"","Italian":"Flogal","Kana":"ふろうがる","Kanji":"","Korean":"","LimitationText":"","MangaIllust":"","Name":"Flogal","Nation":"United Sanctuary","Note":"","OtherNames":"","Phonetic":"Furōgaru","Power":5000,"Race":"High Beast","RideSkill":"","Sets":null,"TournamentStatuses":{"En":"","Jp":"","Kr":"","Th":"","It":""},"Shield":10000,"Skill":"Boost","Thai":"โฟลกัล","Translation":"","TriggerEffect":"Stand / +5000"},{"CardType":"","Clan":"Royal Paladin","Critical":1,"DesignIllus":"","Effect":"[AUTO](VC/RC):[Counter Blast (1)] When this unit attacks, you may pay the cost. If you do, this unit gets [Power]+3000 until end of that battle.","Flavor":"The crime warrants a thousand deaths!","Format":"Premium Standard","Grade":"3","Illust":"wolfina","IllustColor":"","Illust2":"","Illust3":"","Illust4":"","Illust5":"","ImageUrlEn":"https://static.wikia.nocookie.net/cardfight/images/7/7a/MT01-003EN.jpg/revision/latest/scale-to-width-down/274?cb=20131121181552","ImageUrlJp":"https://static.wikia.nocookie.net/cardfight/images/6/65/DG01-003.jpg/revision/latest/scale-to-width-down/274?cb=20130602230309","ImaginaryGift":"","Italian":"Bors, Cavaliere della Condanna","Kana":"だんざいのきし ボールス","Kanji":"断罪の騎士 ボールス","Korean":"","LimitationText":"","MangaIllust":"","Name":"Knight of Conviction, Bors","Nation":"United Sanctuary","Note":"","OtherNames":"","Phonetic":"Danzai no Kishi Bōrusu","Power":10000,"Race":"Human","RideSkill":"","Sets":null,"TournamentStatuses":{"En":"","Jp":"","Kr":"","Th":"","It":""},"Shield":0,"Skill":"Twin Drive!!","Thai":"","Translation":"","TriggerEffect":""},{"CardType":"","Clan":"Royal Paladin","Critical":1,"DesignIllus":"","Effect":"","Flavor":"(TD01/MT01/KAD3/DG01/MB): Silence says it all.(BT01/FC01): My sword, you shall have.(VZ): No problem...... my Vanguard.","Format":"Premium Standard","Grade":"2","Illust":"村枝賢一","IllustColor":"","Illust2":"","Illust3":"","Illust4":"","Illust5":"","ImageUrlEn":"https://static.wikia.nocookie.net/cardfight/images/3/3e/MT01-005EN.jpg/revision/latest/scale-to-width-down/274?cb=20131121181710","ImageUrlJp":"https://static.wikia.nocookie.net/cardfight/images/7/7a/DG01-005.jpg/revision/latest/scale-to-width-down/274?cb=20130602230140","ImaginaryGift":"","Italian":"Gallatin, Cavaliere del Silenzio","Kana":"ちんもくのきし ギャラティン","Kanji":"沈黙の騎士 ギャラティン","Korean":"","LimitationText":"","MangaIllust":"","Name":"Knight of Silence, Gallatin","Nation":"United Sanctuary","Note":"","OtherNames":"","Phonetic":"Chinmoku no Kishi Gyaratin","Power":10000,"Race":"Human","RideSkill":"","Sets":null,"TournamentStatuses":{"En":"","Jp":"","Kr":"","Th":"","It":""},"Shield":5000,"Skill":"Intercept","Thai":"อัศวินแห่งความเงียบ กาลาทิน","Translation":"","TriggerEffect":""},{"CardType":"","Clan":"Royal Paladin","Critical":1,"DesignIllus":"","Effect":"[AUTO]:When this unit intercepts, if you have a «Royal Paladin» vanguard, this card gets [Shield]+5000 until end of that battle.","Flavor":"Unshakable, that is the truth.","Format":"Premium Standard","Grade":"2","Illust":"萩谷薫","IllustColor":"","Illust2":"","Illust3":"","Illust4":"","Illust5":"","ImageUrlEn":"https://static.wikia.nocookie.net/cardfight/images/5/5e/MT01-008EN.jpg/revision/latest/scale-to-width-down/274?cb=20131121182023","ImageUrlJp":"https://static.wikia.nocookie.net/cardfight/images/8/84/DG01-008.jpg/revision/latest/scale-to-width-down/274?cb=20130602230400","ImaginaryGift":"","Italian":"Gordon, Cavaliere della Verità","Kana":"しんりのきし ゴードン","Kanji":"真理の騎士 ゴードン","Korean":"","LimitationText":"","MangaIllust":"","Name":"Knight of Truth, Gordon","Nation":"United Sanctuary","Note":"","OtherNames":"","Phonetic":"Shinri no Kishi Gōdon","Power":8000,"Race":"Human","RideSkill":"","Sets":null,"TournamentStatuses":{"En":"","Jp":"","Kr":"","Th":"","It":""},"Shield":5000,"Skill":"Intercept","Thai":"อัศวินแห่งความจริง,กอร์ดอน","Translation":"","TriggerEffect":""},{"CardType":"","Clan":"Royal Paladin","Critical":1,"DesignIllus":"","Effect":"[ACT](VC/RC):[Counter Blast (1)] This unit gets [Power]+1000 until end of turn.","Flavor":"(PR): Ah, a squire! Their potential shines like the sun!  (VZ): Yes, sir! My Vanguard!","Format":"Premium Standard","Grade":"1","Illust":"Ryo-ta.H‎","IllustColor":"","Illust2":"","Illust3":"","Illust4":"","Illust5":"","ImageUrlEn":"https://static.wikia.nocookie.net/cardfight/images/c/cd/PR-0027EN.jpg/revision/latest/scale-to-width-down/274?cb=20130610231026","ImageUrlJp":"https://static.wikia.nocookie.net/cardfight/images/d/dd/VZ-010.jpg/revision/latest/scale-to-width-down/274?cb=20130412144420","ImaginaryGift":"","Italian":"","Kana":"ナイトスクワイヤ アレン","Kanji":"","Korean":"","LimitationText":"","MangaIllust":"","Name":"Knight Squire, Allen","Nation":"United Sanctuary","Note":"","OtherNames":"","Phonetic":"Naito Sukuwaiya Aren","Power":7000,"Race":"Human","RideSkill":"","Sets":null,"TournamentStatuses":{"En":"","Jp":"","Kr":"","Th":"","It":""},"Shield":5000,"Skill":"Boost","Thai":"","Translation":"","TriggerEffect":""},{"CardType":"","Clan":"Royal Paladin","Critical":1,"DesignIllus":"","Effect":"","Flavor":"(TD01/MT01/KAD3/VZ): My dream is to experience all the wonders of the world.(BT01/FC01/DG01/): Leave it to me! I've got a plan!","Format":"Premium Standard","Grade":"1","Illust":"山﨑奈苗","IllustColor":"","Illust2":"","Illust3":"","Illust4":"","Illust5":"","ImageUrlEn":"https://static.wikia.nocookie.net/cardfight/images/0/0e/MT01-009EN.jpg/revision/latest/scale-to-width-down/274?cb=20131121182129","ImageUrlJp":"https://static.wikia.nocookie.net/cardfight/images/0/09/DG01-009.jpg/revision/latest/scale-to-width-down/274?cb=20130602230426","ImaginaryGift":"","Italian":"Marron, Piccolo Saggio","Kana":"ちいさなけんじゃ マロン","Kanji":"小さな賢者 マロン","Korean":"","LimitationText":"","MangaIllust":"","Name":"Little Sage, Marron","Nation":"United Sanctuary","Note":"","OtherNames":"","Phonetic":"Chīsana Kenja Maron","Power":8000,"Race":"Giant","RideSkill":"","Sets":null,"TournamentStatuses":{"En":"","Jp":"","Kr":"","Th":"","It":""},"Shield":5000,"Skill":"Boost","Thai":"นักปราชญ์น้อย มารอน","Translation":"","TriggerEffect":""},{"CardType":"","Clan":"Royal Paladin","Critical":1,"DesignIllus":"","Effect":"[AUTO](RC):[Choose a card from your hand, and discard it] When an attack hits during the battle that this unit boosted, you may pay the cost. If you do, draw a card.","Flavor":"He is not only cute, but also a brilliant adviser.","Format":"Premium Standard","Grade":"1","Illust":"三好載克‎","IllustColor":"","Illust2":"","Illust3":"","Illust4":"","Illust5":"","ImageUrlEn":"https://static.wikia.nocookie.net/cardfight/images/4/4f/EB03-039EN-C.jpg/revision/latest/scale-to-width-down/274?cb=20121005064653","ImageUrlJp":"https://static.wikia.nocookie.net/cardfight/images/c/ce/VZ-014.jpg/revision/latest/scale-to-width-down/274?cb=20130412144905","ImaginaryGift":"","Italian":"","Kana":"みるびる","Kanji":"","Korean":"","LimitationText":"","MangaIllust":"","Name":"Miru Biru","Nation":"United Sanctuary","Note":"","OtherNames":"","Phonetic":"Mirubiru","Power":6000,"Race":"High Beast","RideSkill":"","Sets":null,"TournamentStatuses":{"En":"","Jp":"","Kr":"","Th":"","It":""},"Shield":5000,"Skill":"Boost","Thai":"","Translation":"","TriggerEffect":""},{"CardType":"","Clan":"Royal Paladin","Critical":1,"DesignIllus":"","Effect":"[ACT](VC):[Counter Blast (2)] If you have a card named \"Blaster Blade\" in your soul, this unit gets [Power]+5000/[Critical]+1 until end of turn.[ACT](Hand):[Reveal this card to your opponent, and put it on top of your deck] Search your deck for up to one card named \"Blaster Blade\", reveal it to your opponent, put it into your hand, and shuffle your deck.","Flavor":"(TD01/VZ): White wings of noble pride. A solitary knight is one who inherits the bravery.(BT01): White wings of noble pride. A solitary knight is one who dances through the battlefield.","Format":"Premium Standard","Grade":"3","Illust":"萩谷薫","IllustColor":"","Illust2":"","Illust3":"","Illust4":"","Illust5":"","ImageUrlEn":"https://static.wikia.nocookie.net/cardfight/images/b/b4/BT01-010EN_RR.jpg/revision/latest/scale-to-width-down/274?cb=20120407134722","ImageUrlJp":"https://static.wikia.nocookie.net/cardfight/images/1/10/VZ-004.jpg/revision/latest/scale-to-width-down/274?cb=20130412144029","ImaginaryGift":"","Italian":"Gancelot, Cavaliere Solitario","Kana":"ここうのきし ガンスロッド","Kanji":"孤高の騎士 ガンスロッド","Korean":"고결한 기사 갠슬롯","LimitationText":"","MangaIllust":"","Name":"Solitary Knight, Gancelot","Nation":"United Sanctuary","Note":"","OtherNames":"","Phonetic":"Kokō no Kishi Gansuroddo","Power":9000,"Race":"Elf","RideSkill":"","Sets":null,"TournamentStatuses":{"En":"","Jp":"","Kr":"","Th":"","It":""},"Shield":0,"Skill":"Twin Drive!!","Thai":"อัศวินผู้โดดเดี่ยว แกรนสล็อต","Translation":"","TriggerEffect":""},{"CardType":"","Clan":"Royal Paladin","Critical":1,"DesignIllus":"","Effect":"[ACT](VC/RC):[Counter Blast (1)] This unit gets [Power]+1000 until end of turn.","Flavor":"The prayer chants give soul to the holy blade.","Format":"Premium Standard","Grade":"1","Illust":"増田幹生","IllustColor":"","Illust2":"","Illust3":"","Illust4":"","Illust5":"","ImageUrlEn":"https://static.wikia.nocookie.net/cardfight/images/7/71/BT02-057EN_C.jpg/revision/latest/scale-to-width-down/274?cb=20120407103704","ImageUrlJp":"https://static.wikia.nocookie.net/cardfight/images/5/50/VZ-011.jpg/revision/latest/scale-to-width-down/274?cb=20130412144509","ImaginaryGift":"","Italian":"Elfo Guida-Anime","Kana":"たましいをみちびくエルフ","Kanji":"魂を導くエルフ","Korean":"","LimitationText":"","MangaIllust":"","Name":"Soul Guiding Elf","Nation":"United Sanctuary","Note":"","OtherNames":"","Phonetic":"Tamashī o Michibiku Erufu","Power":7000,"Race":"Elf","RideSkill":"","Sets":null,"TournamentStatuses":{"En":"","Jp":"","Kr":"","Th":"","It":""},"Shield":5000,"Skill":"Boost","Thai":"","Translation":"","TriggerEffect":""},{"CardType":"","Clan":"Royal Paladin","Critical":1,"DesignIllus":"","Effect":"[AUTO]:When this unit is placed on (RC), choose another of your «Royal Paladin», and that unit gets [Power]+2000 until end of turn.","Flavor":"Unicorn of the sanctuary, loyal only to one who is free of sins.","Format":"Premium Standard","Grade":"1","Illust":"碧風羽","IllustColor":"","Illust2":"","Illust3":"","Illust4":"","Illust5":"","ImageUrlEn":"https://static.wikia.nocookie.net/cardfight/images/2/2a/TD01-010EN.jpg/revision/latest/scale-to-width-down/274?cb=20120411074858","ImageUrlJp":"https://static.wikia.nocookie.net/cardfight/images/3/37/VZ-013.jpg/revision/latest/scale-to-width-down/274?cb=20130412144823","ImaginaryGift":"","Italian":"Unicorno Luce Stellare","Kana":"スターライト・ユニコーン","Kanji":"","Korean":"","LimitationText":"","MangaIllust":"","Name":"Starlight Unicorn","Nation":"United Sanctuary","Note":"","OtherNames":"","Phonetic":"Sutāraito Yunikōn","Power":6000,"Race":"High Beast","RideSkill":"","Sets":null,"TournamentStatuses":{"En":"","Jp":"","Kr":"","Th":"","It":""},"Shield":5000,"Skill":"Boost","Thai":"สตาร์ไลท์ ยูนิคอร์น","Translation":"","TriggerEffect":""},{"CardType":"","Clan":"Royal Paladin","Critical":1,"DesignIllus":"","Effect":"[AUTO](VC/RC):When this unit attacks a vanguard, if you have a «Royal Paladin» vanguard, this unit gets [Power]+2000 until the end of the battle.","Flavor":"The first sword cuts bones, and the second rips through darkness!","Format":"Premium Standard","Grade":"3","Illust":"てるみぃ","IllustColor":"","Illust2":"","Illust3":"","Illust4":"","Illust5":"","ImageUrlEn":"https://static.wikia.nocookie.net/cardfight/images/3/32/EB03-016EN-R.jpg/revision/latest/scale-to-width-down/274?cb=20121005100507","ImageUrlJp":"https://static.wikia.nocookie.net/cardfight/images/a/a9/VZ-002.jpg/revision/latest/scale-to-width-down/274?cb=20130412143918","ImaginaryGift":"","Italian":"","Kana":"そうこうのけんし マーハウス","Kanji":"双煌の剣士 マーハウス","Korean":"","LimitationText":"","MangaIllust":"","Name":"Twin Shine Swordsman, Marhaus","Nation":"United Sanctuary","Note":"","OtherNames":"","Phonetic":"Sōkō no Kenshi Māhausu","Power":10000,"Race":"Human","RideSkill":"","Sets":null,"TournamentStatuses":{"En":"","Jp":"","Kr":"","Th":"","It":""},"Shield":0,"Skill":"Twin Drive!!","Thai":"","Translation":"","TriggerEffect":""},{"CardType":"Trigger Unit","Clan":"Royal Paladin","Critical":1,"DesignIllus":"","Effect":"","Flavor":"(TD01/MT01): C'mon in! Give ya one for free.(BT01): Thanks for coming!","Format":"Premium Standard","Grade":"0","Illust":"Hirokorin","IllustColor":"","Illust2":"","Illust3":"","Illust4":"","Illust5":"","ImageUrlEn":"https://static.wikia.nocookie.net/cardfight/images/2/2e/MT01-015EN.jpg/revision/latest/scale-to-width-down/274?cb=20131121182723","ImageUrlJp":"https://static.wikia.nocookie.net/cardfight/images/d/d1/DG01-015.jpg/revision/latest/scale-to-width-down/274?cb=20130602230643","ImaginaryGift":"","Italian":"Govannon, Mercante d'Armi","Kana":"ぶきしょうにん ゴヴァノン","Kanji":"武器商人 ゴヴァノン","Korean":"","LimitationText":"","MangaIllust":"","Name":"Weapons Dealer, Govannon","Nation":"United Sanctuary","Note":"","OtherNames":"","Phonetic":"Bukishōnin Govanon","Power":5000,"Race":"Gnome","RideSkill":"","Sets":null,"TournamentStatuses":{"En":"","Jp":"","Kr":"","Th":"","It":""},"Shield":5000,"Skill":"Boost","Thai":"พ่อค้าอาวุธ โกวานอน","Translation":"","TriggerEffect":"Draw / +5000"},{"CardType":"","Clan":"Royal Paladin","Critical":1,"DesignIllus":"","Effect":"[AUTO](RC):When this unit boosts a card named \"Blaster Blade\", the boosted unit gets [Power]+4000 until end of that battle.","Flavor":"(TD01/VZ): With a trustful friend, a boy can become a hero.  (BT01): I know. You are braver than anyone else!  (PR): High dogs are the best comrades for paladins.","Format":"Premium Standard","Grade":"1","Illust":"TMS","IllustColor":"","Illust2":"","Illust3":"","Illust4":"","Illust5":"","ImageUrlEn":"https://static.wikia.nocookie.net/cardfight/images/0/01/TD01-009EN.jpg/revision/latest/scale-to-width-down/274?cb=20120411060721","ImageUrlJp":"https://static.wikia.nocookie.net/cardfight/images/9/9b/TD01-009.jpg/revision/latest/scale-to-width-down/274?cb=20111203015054","ImaginaryGift":"","Italian":"Wingal","Kana":"ういんがる","Kanji":"","Korean":"","LimitationText":"","MangaIllust":"","Name":"Wingal","Nation":"United Sanctuary","Note":"","OtherNames":"","Phonetic":"Uingaru","Power":6000,"Race":"High Beast","RideSkill":"","Sets":null,"TournamentStatuses":{"En":"","Jp":"","Kr":"","Th":"","It":""},"Shield":5000,"Skill":"Boost","Thai":"","Translation":"","TriggerEffect":""},{"CardType":"Trigger Unit","Clan":"Royal Paladin","Critical":1,"DesignIllus":"","Effect":"(You may only have up to four cards with \"HEAL\" in a deck.)","Flavor":"(TD01/MT01): Great, you can still fight.(BT01): I will save you. I promise.(G-DG01): This is not the time to give up yet.(PR/408): The Yggdrasil Maiden prays. For the safety of the knights of light.","Format":"Premium Standard","Grade":"0","Illust":"武井宏之","IllustColor":"","Illust2":"","Illust3":"","Illust4":"","Illust5":"","ImageUrlEn":"https://static.wikia.nocookie.net/cardfight/images/4/43/MT01-017EN.jpg/revision/latest/scale-to-width-down/274?cb=20131121183040","ImageUrlJp":"https://static.wikia.nocookie.net/cardfight/images/7/71/PR-0408.png/revision/latest/scale-to-width-down/274?cb=20160702053032","ImaginaryGift":"","Italian":"Elaine, Fanciulla dell'Yggdrasil","Kana":"せいかいじゅのみこ エレイン","Kanji":"世界樹の巫女 エレイン","Korean":"","LimitationText":"","MangaIllust":"","Name":"Yggdrasil Maiden, Elaine","Nation":"United Sanctuary","Note":"","OtherNames":"","Phonetic":"Sekaiju no Miko Erein","Power":5000,"Race":"Elf","RideSkill":"","Sets":null,"TournamentStatuses":{"En":"","Jp":"","Kr":"","Th":"","It":""},"Shield":10000,"Skill":"Boost","Thai":"มิโกะต้นไม้แห่งชีวิต เอเลน","Translation":"World Tree Maiden, Elaine","TriggerEffect":"Heal / +5000"}]}`
						res, err := getHttpResponseString(fmt.Sprintf("%s?name=%s", reqURL, url.PathEscape(setName)))
						if err != nil {
							t.Error(err)
						}
						if res != expected {
							t.Errorf("URL:%q\nResponse: %q\nExpected:%q", reqURL, res, expected)
						}
					})

			})
		})
	})
}

func getHttpResponseString(reqURL string) (string, error) {
	res, err := http.Get(reqURL)
	if err != nil {
		return "", err
	}
	defer res.Body.Close()

	bodyBytes, err := ioutil.ReadAll(res.Body)
	if err != nil {
		return "", err
	}

	return string(bodyBytes), nil
}
